{% extends "base.html" %}

{% block title %}Login{% endblock %}

{% block content %}
    <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow">
        <div class="mb-6 text-center">
            <i class="fas fa-universal-access text-blue-500 text-6xl mb-2"></i>
            <h2 class="text-2xl font-bold text-center text-slate-700 mb-2">Login Quiz Online</h2>
        </div>
        

       <div id="msg" class="hidden text-sm text-center mb-4 py-2 rounded-md"></div>

        <form id="form-login" class="space-y-4" novalidate>
            <div>
                <label for="username" class="block text-slate-700 mb-2">Nama Pengguna / Email</label>
                <input type="text" id="username" name="username" autocomplete="username" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="password" class="block text-slate-700 mb-2">Kata Sandi</label>
                <input type="password" id="password" name="password" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <button id="btn-submit" type="submit"
                class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-blue-700 transition disabled:opacity-60 disabled:cursor-not-allowed">
                <i class="fas fa-unlock-alt text-white mr-1"></i> Masuk
            </button>
        </form>

        <p class="text-center text-sm text-slate-500 mt-4">
            Belum punya akun?
            <a href="{{ url_for('register_page') }}" class="text-blue-600 hover:underline">Daftar</a>
        </p>
    </div>

    <script>
(function () {
  const form      = document.getElementById('form-login');
  const username  = document.getElementById('username');
  const password  = document.getElementById('password');
  const msgEl     = document.getElementById('msg');
  const btn       = document.getElementById('btn-submit');

  function getCookie(name) {
    const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return m ? decodeURIComponent(m[2]) : null;
  }

  function showMsg(text, type = 'info') {
    msgEl.textContent = text;
    msgEl.classList.remove('hidden');
    msgEl.classList.remove(
      'bg-green-100','text-green-700','border','border-green-300',
      'bg-red-100','text-red-700','border-red-300',
      'bg-blue-100','text-blue-700','border-blue-300'
    );
    msgEl.classList.add('text-sm','text-center','py-2','rounded-md','border');
    if (type === 'success') {
      msgEl.classList.add('bg-green-100','text-green-700','border-green-300');
    } else if (type === 'error') {
      msgEl.classList.add('bg-red-100','text-red-700','border-red-300');
    } else {
      msgEl.classList.add('bg-blue-100','text-blue-700','border-blue-300');
    }
  }

  function clearMsg() {
    msgEl.textContent = '';
    msgEl.className = 'hidden text-sm text-center mb-4 py-2 rounded-md';
  }

  function setLoading(isLoading) {
    if (!btn) return;
    btn.disabled = isLoading;
    btn.innerHTML = isLoading
      ? '<i class="fas fa-spinner fa-spin mr-2"></i> Memproses...'
      : '<i class="fas fa-unlock-alt text-white mr-1"></i> Masuk';
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearMsg();

    const uname = (username.value || '').trim();
    const pwd   = password.value || '';
    if (!uname || !pwd) {
      showMsg('Username & password wajib diisi.', 'error');
      return;
    }

    setLoading(true);

    try {
      // siapkan headers lebih dulu
      const headers = { 'Content-Type': 'application/json' };

      // Jika ada cookie CSRF JWT lama, sertakan headernya (menghindari 422)
      const csrf = getCookie('csrf_access_token');
      if (csrf) headers['X-CSRF-TOKEN'] = csrf;

      const res = await fetch('/api/login', {
        method: 'POST',
        headers,
        credentials: 'same-origin',
        body: JSON.stringify({ username: uname, password: pwd })
      });

      const data = await res.json().catch(() => ({}));

      if (res.ok) {
        showMsg('Login berhasil. Mengalihkan...', 'success');

        // contoh validasi cepat token
        const me = await fetch('/api/me', { credentials: 'same-origin' });
        if (me.ok) {
          setTimeout(() => window.location.href = '/', 800);
        } else {
          showMsg('Login berhasil, tapi gagal mengambil profil.', 'error');
          setLoading(false);
        }
      } else {
        // tampilkan pesan dari backend (Flask-JWT-Extended sering pakai 'msg')
        showMsg(data.error || data.msg || 'Login gagal.', 'error');
        setLoading(false);
      }
    } catch (err) {
      console.error(err);
      showMsg('Gagal terhubung ke server. Coba lagi.', 'error');
      setLoading(false);
    }
  });

  // opsional: submit dengan Enter saat fokus di password
  password.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') form.requestSubmit();
  });
})();
</script>

{% endblock %}